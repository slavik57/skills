
// MSSQL Query Compiler
// ------
'use strict';

exports.__esModule = true;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

var _inherits = require('inherits');

var _inherits2 = _interopRequireDefault(_inherits);

var _queryCompiler = require('../../../query/compiler');

var _queryCompiler2 = _interopRequireDefault(_queryCompiler);

var _lodash = require('lodash');

function QueryCompiler_MSSQL(client, builder) {
  _queryCompiler2['default'].call(this, client, builder);
}
_inherits2['default'](QueryCompiler_MSSQL, _queryCompiler2['default']);

_lodash.assign(QueryCompiler_MSSQL.prototype, {

  _emptyInsertValue: 'default values',

  // Compiles an "insert" query, allowing for multiple
  // inserts using a single query statement.
  insert: function insert() {
    var insertValues = this.single.insert || [];
    var sql = 'insert into ' + this.tableName + ' ';
    var returning = this.single.returning;

    var returningSql = returning ? this._returning('insert', returning) + ' ' : '';

    if (Array.isArray(insertValues)) {
      if (insertValues.length === 0) {
        return '';
      }
    } else if (typeof insertValues === 'object' && _lodash.isEmpty(insertValues)) {
      return {
        sql: sql + returningSql + this._emptyInsertValue,
        returning: returning
      };
    }

    var insertData = this._prepInsert(insertValues);
    if (typeof insertData === 'string') {
      sql += insertData;
    } else {
      if (insertData.columns.length) {
        sql += '(' + this.formatter.columnize(insertData.columns);
        sql += ') ' + returningSql + 'values (';
        var i = -1;
        while (++i < insertData.values.length) {
          if (i !== 0) sql += '), (';
          sql += this.formatter.parameterize(insertData.values[i], this.client.valueForUndefined);
        }
        sql += ')';
      } else if (insertValues.length === 1 && insertValues[0]) {
        sql += returningSql + this._emptyInsertValue;
      } else {
        sql = '';
      }
    }
    return {
      sql: sql,
      returning: returning
    };
  },

  // Compiles an `update` query, allowing for a return value.
  update: function update() {
    var updates = this._prepUpdate(this.single.update);
    var join = this.join();
    var where = this.where();
    var order = this.order();
    var top = this.top();
    var returning = this.single.returning;

    return {
      sql: 'update ' + (top ? top + ' ' : '') + this.tableName + (join ? ' ' + join : '') + ' set ' + updates.join(', ') + (returning ? ' ' + this._returning('update', returning) : '') + (where ? ' ' + where : '') + (order ? ' ' + order : '') + (!returning ? this._returning('rowcount', '@@rowcount') : ''),
      returning: returning || '@@rowcount'
    };
  },

  // Compiles a `delete` query.
  del: function del() {
    // Make sure tableName is processed by the formatter first.
    var tableName = this.tableName;

    var wheres = this.where();
    var returning = this.single.returning;

    return {
      sql: 'delete from ' + tableName + (returning ? ' ' + this._returning('del', returning) : '') + (wheres ? ' ' + wheres : '') + (!returning ? this._returning('rowcount', '@@rowcount') : ''),
      returning: returning || '@@rowcount'
    };
  },

  // Compiles the columns in the query, specifying if an item was distinct.
  columns: function columns() {
    var distinct = false;
    if (this.onlyUnions()) return '';
    var columns = this.grouped.columns || [];
    var i = -1,
        sql = [];
    if (columns) {
      while (++i < columns.length) {
        var stmt = columns[i];
        if (stmt.distinct) distinct = true;
        if (stmt.type === 'aggregate') {
          sql.push(this.aggregate(stmt));
        } else if (stmt.value && stmt.value.length > 0) {
          sql.push(this.formatter.columnize(stmt.value));
        }
      }
    }
    if (sql.length === 0) sql = ['*'];
    var top = this.top();
    return 'select ' + (distinct ? 'distinct ' : '') + (top ? top + ' ' : '') + sql.join(', ') + (this.tableName ? ' from ' + this.tableName : '');
  },

  _returning: function _returning(method, value) {
    switch (method) {
      case 'update':
      case 'insert':
        return value ? 'output ' + this.formatter.columnizeWithPrefix('inserted.', value) : '';
      case 'del':
        return value ? 'output ' + this.formatter.columnizeWithPrefix('deleted.', value) : '';
      case 'rowcount':
        return value ? ';select @@rowcount' : '';
    }
  },

  // Compiles a `truncate` query.
  truncate: function truncate() {
    return 'truncate table ' + this.tableName;
  },

  forUpdate: function forUpdate() {
    return 'with (READCOMMITTEDLOCK)';
  },

  forShare: function forShare() {
    return 'with (NOLOCK)';
  },

  // Compiles a `columnInfo` query.
  columnInfo: function columnInfo() {
    var column = this.single.columnInfo;
    var sql = 'select * from information_schema.columns where table_name = ? and table_schema = \'dbo\'';
    return {
      sql: sql,
      bindings: [this.single.table],
      output: function output(resp) {
        var out = resp.reduce(function (columns, val) {
          columns[val.COLUMN_NAME] = {
            defaultValue: val.COLUMN_DEFAULT,
            type: val.DATA_TYPE,
            maxLength: val.CHARACTER_MAXIMUM_LENGTH,
            nullable: val.IS_NULLABLE === 'YES'
          };
          return columns;
        }, {});
        return column && out[column] || out;
      }
    };
  },

  top: function top() {
    var noLimit = !this.single.limit && this.single.limit !== 0;
    var noOffset = !this.single.offset;
    if (noLimit || !noOffset) return '';
    return 'top (' + this.formatter.parameter(this.single.limit) + ')';
  },

  limit: function limit() {
    return '';
  },

  offset: function offset() {
    var noLimit = !this.single.limit && this.single.limit !== 0;
    var noOffset = !this.single.offset;
    if (noOffset) return '';
    var offset = 'offset ' + (noOffset ? '0' : this.formatter.parameter(this.single.offset)) + ' rows';
    if (!noLimit) {
      offset += ' fetch next ' + this.formatter.parameter(this.single.limit) + ' rows only';
    }
    return offset;
  }

});

// Set the QueryBuilder & QueryCompiler on the client object,
// in case anyone wants to modify things to suit their own purposes.
exports['default'] = QueryCompiler_MSSQL;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9kaWFsZWN0cy9tc3NxbC9xdWVyeS9jb21waWxlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7d0JBR3FCLFVBQVU7Ozs7NkJBQ0wseUJBQXlCOzs7O3NCQUVuQixRQUFROztBQUV4QyxTQUFTLG1CQUFtQixDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUU7QUFDNUMsNkJBQWMsSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUE7Q0FDMUM7QUFDRCxzQkFBUyxtQkFBbUIsNkJBQWdCLENBQUE7O0FBRTVDLGVBQU8sbUJBQW1CLENBQUMsU0FBUyxFQUFFOztBQUVwQyxtQkFBaUIsRUFBRSxnQkFBZ0I7Ozs7QUFJbkMsUUFBTSxFQUFBLGtCQUFHO0FBQ1AsUUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLElBQUksRUFBRSxDQUFDO0FBQzlDLFFBQUksR0FBRyxvQkFBa0IsSUFBSSxDQUFDLFNBQVMsTUFBRyxDQUFDO1FBQ25DLFNBQVMsR0FBSyxJQUFJLENBQUMsTUFBTSxDQUF6QixTQUFTOztBQUNqQixRQUFNLFlBQVksR0FBRyxTQUFTLEdBQzFCLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxHQUFHLEdBQUcsR0FDMUMsRUFBRSxDQUFDOztBQUVQLFFBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsRUFBRTtBQUMvQixVQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO0FBQzdCLGVBQU8sRUFBRSxDQUFBO09BQ1Y7S0FDRixNQUFNLElBQUksT0FBTyxZQUFZLEtBQUssUUFBUSxJQUFJLGdCQUFRLFlBQVksQ0FBQyxFQUFFO0FBQ3BFLGFBQU87QUFDTCxXQUFHLEVBQUUsR0FBRyxHQUFHLFlBQVksR0FBRyxJQUFJLENBQUMsaUJBQWlCO0FBQ2hELGlCQUFTLEVBQVQsU0FBUztPQUNWLENBQUM7S0FDSDs7QUFF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LFFBQU0sT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDO0FBQzlELFFBQU0sUUFBUSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7QUFDckMsUUFBSSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUM7QUFDeEIsUUFBSSxNQUFNLGdCQUFhLFFBQVEsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQSxVQUFPLENBQUM7QUFDNUYsUUFBSSxDQUFDLE9BQU8sRUFBRTtBQUNaLFlBQU0scUJBQW1CLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGVBQVksQ0FBQztLQUNsRjtBQUNELFdBQU8sTUFBTSxDQUFDO0dBQ2Y7O0NBRUYsQ0FBQyxDQUFBOzs7O3FCQUlhLG1CQUFtQiIsImZpbGUiOiJjb21waWxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuLy8gTVNTUUwgUXVlcnkgQ29tcGlsZXJcbi8vIC0tLS0tLVxuaW1wb3J0IGluaGVyaXRzIGZyb20gJ2luaGVyaXRzJztcbmltcG9ydCBRdWVyeUNvbXBpbGVyIGZyb20gJy4uLy4uLy4uL3F1ZXJ5L2NvbXBpbGVyJztcblxuaW1wb3J0IHsgYXNzaWduLCBpc0VtcHR5IH0gZnJvbSAnbG9kYXNoJ1xuXG5mdW5jdGlvbiBRdWVyeUNvbXBpbGVyX01TU1FMKGNsaWVudCwgYnVpbGRlcikge1xuICBRdWVyeUNvbXBpbGVyLmNhbGwodGhpcywgY2xpZW50LCBidWlsZGVyKVxufVxuaW5oZXJpdHMoUXVlcnlDb21waWxlcl9NU1NRTCwgUXVlcnlDb21waWxlcilcblxuYXNzaWduKFF1ZXJ5Q29tcGlsZXJfTVNTUUwucHJvdG90eXBlLCB7XG5cbiAgX2VtcHR5SW5zZXJ0VmFsdWU6ICdkZWZhdWx0IHZhbHVlcycsXG5cbiAgLy8gQ29tcGlsZXMgYW4gXCJpbnNlcnRcIiBxdWVyeSwgYWxsb3dpbmcgZm9yIG11bHRpcGxlXG4gIC8vIGluc2VydHMgdXNpbmcgYSBzaW5nbGUgcXVlcnkgc3RhdGVtZW50LlxuICBpbnNlcnQoKSB7XG4gICAgY29uc3QgaW5zZXJ0VmFsdWVzID0gdGhpcy5zaW5nbGUuaW5zZXJ0IHx8IFtdO1xuICAgIGxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLnRhYmxlTmFtZX0gYDtcbiAgICBjb25zdCB7IHJldHVybmluZyB9ID0gdGhpcy5zaW5nbGU7XG4gICAgY29uc3QgcmV0dXJuaW5nU3FsID0gcmV0dXJuaW5nXG4gICAgICA/IHRoaXMuX3JldHVybmluZygnaW5zZXJ0JywgcmV0dXJuaW5nKSArICcgJ1xuICAgICAgOiAnJztcblxuICAgIGlmIChBcnJheS5pc0FycmF5KGluc2VydFZhbHVlcykpIHtcbiAgICAgIGlmIChpbnNlcnRWYWx1ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiAnJ1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodHlwZW9mIGluc2VydFZhbHVlcyA9PT0gJ29iamVjdCcgJiYgaXNFbXB0eShpbnNlcnRWYWx1ZXMpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzcWw6IHNxbCArIHJldHVybmluZ1NxbCArIHRoaXMuX2VtcHR5SW5zZXJ0VmFsdWUsXG4gICAgICAgIHJldHVybmluZ1xuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnNlcnREYXRhID0gdGhpcy5fcHJlcEluc2VydChpbnNlcnRWYWx1ZXMpO1xuICAgIGlmICh0eXBlb2YgaW5zZXJ0RGF0YSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHNxbCArPSBpbnNlcnREYXRhO1xuICAgIH0gZWxzZSAge1xuICAgICAgaWYgKGluc2VydERhdGEuY29sdW1ucy5sZW5ndGgpIHtcbiAgICAgICAgc3FsICs9IGAoJHt0aGlzLmZvcm1hdHRlci5jb2x1bW5pemUoaW5zZXJ0RGF0YS5jb2x1bW5zKX1gXG4gICAgICAgIHNxbCArPSBgKSAke3JldHVybmluZ1NxbH12YWx1ZXMgKGBcbiAgICAgICAgbGV0IGkgPSAtMVxuICAgICAgICB3aGlsZSAoKytpIDwgaW5zZXJ0RGF0YS52YWx1ZXMubGVuZ3RoKSB7XG4gICAgICAgICAgaWYgKGkgIT09IDApIHNxbCArPSAnKSwgKCdcbiAgICAgICAgICBzcWwgKz0gdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyaXplKFxuICAgICAgICAgICAgaW5zZXJ0RGF0YS52YWx1ZXNbaV0sIHRoaXMuY2xpZW50LnZhbHVlRm9yVW5kZWZpbmVkXG4gICAgICAgICAgKVxuICAgICAgICB9XG4gICAgICAgIHNxbCArPSAnKSc7XG4gICAgICB9IGVsc2UgaWYgKGluc2VydFZhbHVlcy5sZW5ndGggPT09IDEgJiYgaW5zZXJ0VmFsdWVzWzBdKSB7XG4gICAgICAgIHNxbCArPSByZXR1cm5pbmdTcWwgKyB0aGlzLl9lbXB0eUluc2VydFZhbHVlXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzcWwgPSAnJ1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgc3FsLFxuICAgICAgcmV0dXJuaW5nXG4gICAgfTtcbiAgfSxcblxuICAvLyBDb21waWxlcyBhbiBgdXBkYXRlYCBxdWVyeSwgYWxsb3dpbmcgZm9yIGEgcmV0dXJuIHZhbHVlLlxuICB1cGRhdGUoKSB7XG4gICAgY29uc3QgdXBkYXRlcyA9IHRoaXMuX3ByZXBVcGRhdGUodGhpcy5zaW5nbGUudXBkYXRlKTtcbiAgICBjb25zdCBqb2luID0gdGhpcy5qb2luKCk7XG4gICAgY29uc3Qgd2hlcmUgPSB0aGlzLndoZXJlKCk7XG4gICAgY29uc3Qgb3JkZXIgPSB0aGlzLm9yZGVyKCk7XG4gICAgY29uc3QgdG9wID0gdGhpcy50b3AoKTtcbiAgICBjb25zdCB7IHJldHVybmluZyB9ID0gdGhpcy5zaW5nbGU7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNxbDogYHVwZGF0ZSAke3RvcCA/IHRvcCArICcgJyA6ICcnfSR7dGhpcy50YWJsZU5hbWV9YCArXG4gICAgICAgIChqb2luID8gYCAke2pvaW59YCA6ICcnKSArXG4gICAgICAgICcgc2V0ICcgKyB1cGRhdGVzLmpvaW4oJywgJykgK1xuICAgICAgICAocmV0dXJuaW5nID8gYCAke3RoaXMuX3JldHVybmluZygndXBkYXRlJywgcmV0dXJuaW5nKX1gIDogJycpICtcbiAgICAgICAgKHdoZXJlID8gYCAke3doZXJlfWAgOiAnJykgK1xuICAgICAgICAob3JkZXIgPyBgICR7b3JkZXJ9YCA6ICcnKSArXG4gICAgICAgICghcmV0dXJuaW5nID8gdGhpcy5fcmV0dXJuaW5nKCdyb3djb3VudCcsICdAQHJvd2NvdW50JykgOiAnJyksXG4gICAgICByZXR1cm5pbmc6IHJldHVybmluZyB8fCAnQEByb3djb3VudCdcbiAgICB9O1xuICB9LFxuXG4gIC8vIENvbXBpbGVzIGEgYGRlbGV0ZWAgcXVlcnkuXG4gIGRlbCgpIHtcbiAgICAvLyBNYWtlIHN1cmUgdGFibGVOYW1lIGlzIHByb2Nlc3NlZCBieSB0aGUgZm9ybWF0dGVyIGZpcnN0LlxuICAgIGNvbnN0IHsgdGFibGVOYW1lIH0gPSB0aGlzO1xuICAgIGNvbnN0IHdoZXJlcyA9IHRoaXMud2hlcmUoKTtcbiAgICBjb25zdCB7IHJldHVybmluZyB9ID0gdGhpcy5zaW5nbGU7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNxbDogYGRlbGV0ZSBmcm9tICR7dGFibGVOYW1lfWAgK1xuICAgICAgICAocmV0dXJuaW5nID8gYCAke3RoaXMuX3JldHVybmluZygnZGVsJywgcmV0dXJuaW5nKX1gIDogJycpICtcbiAgICAgICAgKHdoZXJlcyA/IGAgJHt3aGVyZXN9YCA6ICcnKSArXG4gICAgICAgICghcmV0dXJuaW5nID8gdGhpcy5fcmV0dXJuaW5nKCdyb3djb3VudCcsICdAQHJvd2NvdW50JykgOiAnJyksXG4gICAgICByZXR1cm5pbmc6IHJldHVybmluZyB8fCAnQEByb3djb3VudCdcbiAgICB9O1xuICB9LFxuXG5cbiAgLy8gQ29tcGlsZXMgdGhlIGNvbHVtbnMgaW4gdGhlIHF1ZXJ5LCBzcGVjaWZ5aW5nIGlmIGFuIGl0ZW0gd2FzIGRpc3RpbmN0LlxuICBjb2x1bW5zKCkge1xuICAgIGxldCBkaXN0aW5jdCA9IGZhbHNlO1xuICAgIGlmICh0aGlzLm9ubHlVbmlvbnMoKSkgcmV0dXJuICcnXG4gICAgY29uc3QgY29sdW1ucyA9IHRoaXMuZ3JvdXBlZC5jb2x1bW5zIHx8IFtdXG4gICAgbGV0IGkgPSAtMSwgc3FsID0gW107XG4gICAgaWYgKGNvbHVtbnMpIHtcbiAgICAgIHdoaWxlICgrK2kgPCBjb2x1bW5zLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBzdG10ID0gY29sdW1uc1tpXTtcbiAgICAgICAgaWYgKHN0bXQuZGlzdGluY3QpIGRpc3RpbmN0ID0gdHJ1ZVxuICAgICAgICBpZiAoc3RtdC50eXBlID09PSAnYWdncmVnYXRlJykge1xuICAgICAgICAgIHNxbC5wdXNoKHRoaXMuYWdncmVnYXRlKHN0bXQpKVxuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHN0bXQudmFsdWUgJiYgc3RtdC52YWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgc3FsLnB1c2godGhpcy5mb3JtYXR0ZXIuY29sdW1uaXplKHN0bXQudmFsdWUpKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzcWwubGVuZ3RoID09PSAwKSBzcWwgPSBbJyonXTtcbiAgICBjb25zdCB0b3AgPSB0aGlzLnRvcCgpO1xuICAgIHJldHVybiBgc2VsZWN0ICR7ZGlzdGluY3QgPyAnZGlzdGluY3QgJyA6ICcnfWAgK1xuICAgICAgKHRvcCA/IHRvcCArICcgJyA6ICcnKSArXG4gICAgICBzcWwuam9pbignLCAnKSArICh0aGlzLnRhYmxlTmFtZSA/IGAgZnJvbSAke3RoaXMudGFibGVOYW1lfWAgOiAnJyk7XG4gIH0sXG5cbiAgX3JldHVybmluZyhtZXRob2QsIHZhbHVlKSB7XG4gICAgc3dpdGNoIChtZXRob2QpIHtcbiAgICAgIGNhc2UgJ3VwZGF0ZSc6XG4gICAgICBjYXNlICdpbnNlcnQnOlxuICAgICAgICByZXR1cm4gdmFsdWVcbiAgICAgICAgICA/IGBvdXRwdXQgJHt0aGlzLmZvcm1hdHRlci5jb2x1bW5pemVXaXRoUHJlZml4KCdpbnNlcnRlZC4nLCB2YWx1ZSl9YFxuICAgICAgICAgIDogJyc7XG4gICAgICBjYXNlICdkZWwnOlxuICAgICAgICByZXR1cm4gdmFsdWVcbiAgICAgICAgICA/IGBvdXRwdXQgJHt0aGlzLmZvcm1hdHRlci5jb2x1bW5pemVXaXRoUHJlZml4KCdkZWxldGVkLicsIHZhbHVlKX1gXG4gICAgICAgICAgOiAnJztcbiAgICAgIGNhc2UgJ3Jvd2NvdW50JzpcbiAgICAgICAgcmV0dXJuIHZhbHVlXG4gICAgICAgICAgPyAnO3NlbGVjdCBAQHJvd2NvdW50J1xuICAgICAgICAgIDogJyc7XG4gICAgfVxuICB9LFxuXG4gIC8vIENvbXBpbGVzIGEgYHRydW5jYXRlYCBxdWVyeS5cbiAgdHJ1bmNhdGUoKSB7XG4gICAgcmV0dXJuIGB0cnVuY2F0ZSB0YWJsZSAke3RoaXMudGFibGVOYW1lfWA7XG4gIH0sXG5cbiAgZm9yVXBkYXRlKCkge1xuICAgIHJldHVybiAnd2l0aCAoUkVBRENPTU1JVFRFRExPQ0spJztcbiAgfSxcblxuICBmb3JTaGFyZSgpIHtcbiAgICByZXR1cm4gJ3dpdGggKE5PTE9DSyknO1xuICB9LFxuXG4gIC8vIENvbXBpbGVzIGEgYGNvbHVtbkluZm9gIHF1ZXJ5LlxuICBjb2x1bW5JbmZvKCkge1xuICAgIGNvbnN0IGNvbHVtbiA9IHRoaXMuc2luZ2xlLmNvbHVtbkluZm87XG4gICAgY29uc3Qgc3FsID1cbiAgICAgIGBzZWxlY3QgKiBmcm9tIGluZm9ybWF0aW9uX3NjaGVtYS5jb2x1bW5zIHdoZXJlIHRhYmxlX25hbWUgPSA/IGFuZCB0YWJsZV9zY2hlbWEgPSAnZGJvJ2A7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNxbCxcbiAgICAgIGJpbmRpbmdzOiBbdGhpcy5zaW5nbGUudGFibGVdLFxuICAgICAgb3V0cHV0KHJlc3ApIHtcbiAgICAgICAgY29uc3Qgb3V0ID0gcmVzcC5yZWR1Y2UoZnVuY3Rpb24oY29sdW1ucywgdmFsKSB7XG4gICAgICAgICAgY29sdW1uc1t2YWwuQ09MVU1OX05BTUVdID0ge1xuICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiB2YWwuQ09MVU1OX0RFRkFVTFQsXG4gICAgICAgICAgICB0eXBlOiB2YWwuREFUQV9UWVBFLFxuICAgICAgICAgICAgbWF4TGVuZ3RoOiB2YWwuQ0hBUkFDVEVSX01BWElNVU1fTEVOR1RILFxuICAgICAgICAgICAgbnVsbGFibGU6ICh2YWwuSVNfTlVMTEFCTEUgPT09ICdZRVMnKVxuICAgICAgICAgIH07XG4gICAgICAgICAgcmV0dXJuIGNvbHVtbnNcbiAgICAgICAgfSwge30pXG4gICAgICAgIHJldHVybiBjb2x1bW4gJiYgb3V0W2NvbHVtbl0gfHwgb3V0O1xuICAgICAgfVxuICAgIH07XG4gIH0sXG5cbiAgdG9wKCkge1xuICAgIGNvbnN0IG5vTGltaXQgPSAhdGhpcy5zaW5nbGUubGltaXQgJiYgdGhpcy5zaW5nbGUubGltaXQgIT09IDA7XG4gICAgY29uc3Qgbm9PZmZzZXQgPSAhdGhpcy5zaW5nbGUub2Zmc2V0O1xuICAgIGlmIChub0xpbWl0IHx8ICFub09mZnNldCkgcmV0dXJuICcnO1xuICAgIHJldHVybiBgdG9wICgke3RoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLnNpbmdsZS5saW1pdCl9KWA7XG4gIH0sXG5cbiAgbGltaXQoKSB7XG4gICAgcmV0dXJuICcnO1xuICB9LFxuXG4gIG9mZnNldCgpIHtcbiAgICBjb25zdCBub0xpbWl0ID0gIXRoaXMuc2luZ2xlLmxpbWl0ICYmIHRoaXMuc2luZ2xlLmxpbWl0ICE9PSAwO1xuICAgIGNvbnN0IG5vT2Zmc2V0ID0gIXRoaXMuc2luZ2xlLm9mZnNldDtcbiAgICBpZiAobm9PZmZzZXQpIHJldHVybiAnJztcbiAgICBsZXQgb2Zmc2V0ID0gYG9mZnNldCAke25vT2Zmc2V0ID8gJzAnIDogdGhpcy5mb3JtYXR0ZXIucGFyYW1ldGVyKHRoaXMuc2luZ2xlLm9mZnNldCl9IHJvd3NgO1xuICAgIGlmICghbm9MaW1pdCkge1xuICAgICAgb2Zmc2V0ICs9IGAgZmV0Y2ggbmV4dCAke3RoaXMuZm9ybWF0dGVyLnBhcmFtZXRlcih0aGlzLnNpbmdsZS5saW1pdCl9IHJvd3Mgb25seWA7XG4gICAgfVxuICAgIHJldHVybiBvZmZzZXQ7XG4gIH0sXG5cbn0pXG5cbi8vIFNldCB0aGUgUXVlcnlCdWlsZGVyICYgUXVlcnlDb21waWxlciBvbiB0aGUgY2xpZW50IG9iamVjdCxcbi8vIGluIGNhc2UgYW55b25lIHdhbnRzIHRvIG1vZGlmeSB0aGluZ3MgdG8gc3VpdCB0aGVpciBvd24gcHVycG9zZXMuXG5leHBvcnQgZGVmYXVsdCBRdWVyeUNvbXBpbGVyX01TU1FMO1xuIl19